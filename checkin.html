<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --radius:16px;

      --shadow: 0 10px 28px rgba(17,24,39,.08);
      --primary:#111827;
      --blue:#2563eb;
      --ok:#16a34a;
      --warn:#b45309;
      --soft:#f9fafb;
      --accent:#0ea5e9;
    }
    * , *::before, *::after { box-sizing: border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    .header{
      height:64px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      border-bottom:1px solid var(--line);
      padding:0 16px;
      background:#fff;
    }
    .header-title{
      grid-column:2;
      font-size:22px;
      font-weight:900;
      text-align:center;
    }
    .header-home{
      grid-column:3;
      justify-self:end;
      font-size:18px;
      font-weight:800;
      text-decoration:none;
      color: var(--blue);
    }

    /* ===== ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== */
    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      background:#fff;
      box-shadow: var(--shadow);
    }

    .card-title{
      font-size:18px;
      font-weight:900;
      margin:0 0 12px;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
    .status-pill{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      font-weight:900;
      background: var(--soft);
    }
    .status-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dot{ width:12px;height:12px;border-radius:999px; flex:0 0 auto; }
    .pill-warn .dot{ background: var(--warn); box-shadow: 0 0 0 7px rgba(180,83,9,.14); }
    .pill-ok   .dot{ background: var(--ok);   box-shadow: 0 0 0 7px rgba(22,163,74,.14); }

    .status-text{
      font-size:18px;
      font-weight:1000;
      letter-spacing:.02em;
      white-space:nowrap;
    }
    .status-sub{
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      margin-top:2px;
      line-height:1.55;
    }

    .status-meta{
      text-align:right;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.3;
    }

    .btns{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      border-radius:16px;
      padding:16px 16px;
      font-weight:900;
      font-size:18px;
      min-height:56px;
      box-shadow: var(--shadow);
      background: var(--primary);
      color:#fff;
      text-align:center;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.secondary{
      background:#fff;
      color: var(--text);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:900;
    }

    .btn.blue{
      background: var(--blue);
    }

    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .hint{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      line-height:1.6;
    }

    /* ===== âœ… å…¨ç”»é¢ï¼šã‚¢ãƒ—ãƒªèª˜å°ï¼ˆãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ç›´å¾Œï¼‰ ===== */
    .gate{
      position:fixed;
      inset:0;
      background:#fff;
      z-index:9999;
      display:none;
      padding:18px 18px calc(18px + env(safe-area-inset-bottom));
    }
    .gateInner{
      max-width:520px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:100%;
    }
    .gateTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-top: env(safe-area-inset-top);
    }
    .gateBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 12px;
      font-weight:1000;
      background:var(--soft);
      font-size:13px;
      color:var(--text);
    }
    .gateCard{
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      background:#fff;
    }
    .gateHero{
      border-radius:18px;
      padding:16px;
      background: linear-gradient(180deg, #ecfeff 0%, #ffffff 65%);
      border:1px solid #cffafe;
    }
    .gateTitle{
      margin:0;
      font-size:22px;
      font-weight:1000;
      line-height:1.25;
      letter-spacing:.01em;
    }
    .gateEm{
      display:inline-block;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background:#0ea5e91a;
      border:1px solid #0ea5e933;
      font-weight:1000;
      font-size:16px;
    }
    .gateDesc{
      margin:10px 0 0;
      color:var(--muted);
      font-weight:900;
      line-height:1.7;
      font-size:14px;
    }
    .gatePoints{
      margin:12px 0 0;
      padding-left:18px;
      font-weight:900;
    }
    .gatePoints li{ margin:7px 0; font-size:14px; }
    .gateActions{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .gateSmall{
      background:transparent;
      border:0;
      color:var(--muted);
      font-weight:900;
      font-size:14px;
      text-decoration:underline;
      cursor:pointer;
      padding:6px 8px;
      justify-self:center;
    }
    .gateFoot{
      margin-top:auto;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      line-height:1.6;
      text-align:center;
    }
    .countdown{
      font-weight:1000;
      color:var(--text);
    }
  </style>
</head>

<body>
  <header class="header">
    <div></div>
    <div class="header-title">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</div>
    <a class="header-home" href="./index.html">ãƒ›ãƒ¼ãƒ </a>
  </header>

  <div class="wrap">

    <!-- âœ… æœ€ä¸Šéƒ¨ï¼šãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³çŠ¶æ…‹ -->
    <section class="card">
      <div class="card-title">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³çŠ¶æ…‹</div>

      <div id="statusPill" class="status-pill pill-warn">
        <div class="status-left">
          <span class="dot"></span>
          <div>
            <div id="statusText" class="status-text">æœªãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</div>
            <div id="statusSub" class="status-sub">
              å—ä»˜ã§æ¡ˆå†…ãŒã‚ã£ãŸæ–¹ã¯ã€Œãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„
            </div>
          </div>
        </div>

        <div class="status-meta">
          <div>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ™‚åˆ»</div>
          <div id="checkedAt">â€”</div>
        </div>
      </div>

      <div class="btns">
        <button class="btn" id="checkinBtn" type="button">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã™ã‚‹</button>
        <button class="btn secondary" id="resetBtn" type="button" style="display:none;">æœªãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã«æˆ»ã™ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰</button>
      </div>

      <div class="hint">
        â€»ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å¾Œã‚‚ã€ã“ã®ç”»é¢ï¼ˆLINEãƒŸãƒ‹ã‚¢ãƒ—ãƒªï¼‰ã§æ“ä½œã§ãã¾ã™ã€‚
      </div>
    </section>

  </div>

  <!-- âœ… ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ç›´å¾Œï¼šå…¨ç”»é¢ã§ã‚¢ãƒ—ãƒªè¨´æ±‚ â†’ ã‚¹ãƒˆã‚¢ã¸é·ç§» -->
  <section class="gate" id="installGate" aria-label="ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ã”æ¡ˆå†…">
    <div class="gateInner">
      <div class="gateTop">
        <div class="gateBadge">âœ… ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†</div>
        <div class="gateBadge">è‡ªå‹•ã§ã‚¹ãƒˆã‚¢ã¸ç§»å‹•ï¼š<span class="countdown" id="cd">2</span>ç§’</div>
      </div>

      <div class="gateHero">
        <h2 class="gateTitle">ã‚¢ãƒ—ãƒªã‚’å…¥ã‚Œã‚‹ã¨ã€<br/>ã‚ªãƒ¼ãƒ€ãƒ¼ãŒã§ãã¾ã™</h2>
        <div class="gateEm">ğŸ“£ ã‚ªãƒ¼ãƒ€ãƒ¼æ©Ÿèƒ½ã¯ã‚¢ãƒ—ãƒªã‹ã‚‰åˆ©ç”¨ã§ãã¾ã™</div>
        <p class="gateDesc">
          ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br/>
          å½“æ—¥ã®ã‚ªãƒ¼ãƒ€ãƒ¼ï¼ˆå£²åº—ï¼ä¼‘æ†©å®¤ãªã©ï¼‰ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ã™ã‚‹ãŸã‚ã€ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ãŠã™ã™ã‚ã—ã¾ã™ï¼ˆç„¡æ–™ï¼‰ã€‚
        </p>
      </div>

      <div class="gateCard">
        <ul class="gatePoints">
          <li>ã‚ªãƒ¼ãƒ€ãƒ¼ãŒã™ãã§ãã¦è¿·ã„ã«ãã„</li>
          <li>é€šçŸ¥ã§å—ã‘å–ã‚ŠãŒå¯èƒ½ã§æ¡ˆå†…ã‚’è¦‹é€ƒã—ã«ãã„</li>
        </ul>

        <div class="gateActions">
          <button class="btn blue" id="goStoreBtn" type="button">ã‚¹ãƒˆã‚¢ã¸é€²ã‚€</button>
          <button class="gateSmall" id="skipBtn" type="button">ä»Šã¯ã—ãªã„ï¼ˆLINEãƒŸãƒ‹ã‚¢ãƒ—ãƒªã§ç¶šã‘ã‚‹ï¼‰</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          â€»è‡ªå‹•é·ç§»ã—ãªã„å ´åˆã¯ã€Œã‚¹ãƒˆã‚¢ã¸é€²ã‚€ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>

      <div class="gateFoot">
        â€»ãƒ¢ãƒƒã‚¯ã®ãŸã‚ã€URLã¯å¾Œã§å·®ã—æ›¿ãˆãŒå¿…è¦ã§ã™ã€‚<br/>
        â€»ãƒ–ãƒ©ã‚¦ã‚¶/ç«¯æœ«ã«ã‚ˆã‚Šã€é·ç§»ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
      </div>
    </div>
  </section>

<script>
  // âœ… LINEã‚¢ãƒ—ãƒªã®ã‚¹ãƒˆã‚¢URLï¼ˆç«¯æœ«åˆ¥ï¼‰
  const STORE_URL_ANDROID = "https://play.google.com/store/apps/details?id=jp.naver.line.android&hl=ja";
  const STORE_URL_IOS = "https://apps.apple.com/jp/app/line/id443904275"; // LINE (iPhone)
  const STORE_URL_WEB = STORE_URL_ANDROID; // Webã¯Google Playã¸

  // ===== ãƒ‡ãƒ¢çŠ¶æ…‹ä¿å­˜ =====
  const LS_KEY = "miniapp_checkin_done_soft";

  const statusPill = document.getElementById("statusPill");
  const statusText = document.getElementById("statusText");
  const statusSub  = document.getElementById("statusSub");
  const checkinBtn = document.getElementById("checkinBtn");
  const resetBtn   = document.getElementById("resetBtn");
  const checkedAt  = document.getElementById("checkedAt");

  // å…¨ç”»é¢èª˜å°
  const installGate = document.getElementById("installGate");
  const cdEl = document.getElementById("cd");
  const goStoreBtn = document.getElementById("goStoreBtn");
  const skipBtn = document.getElementById("skipBtn");

  let redirectTimer = null;
  let countdownTimer = null;
  let locked = false;

  function pad(n){ return String(n).padStart(2,"0"); }
  function nowText(){
    const now = new Date();
    return `${now.getFullYear()}/${pad(now.getMonth()+1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  }

  function saveCheckedIn(ts){
    localStorage.setItem(LS_KEY, JSON.stringify({ checkedAt: ts }));
  }
  function clearCheckedIn(){
    localStorage.removeItem(LS_KEY);
  }

  function setCheckedInUI(ts){
    statusPill.classList.remove("pill-warn");
    statusPill.classList.add("pill-ok");
    statusText.textContent = "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ¸ˆã¿";
    statusSub.textContent  = "ã“ã®ã¾ã¾ãŠé€²ã¿ãã ã•ã„ã€‚";

    checkedAt.textContent = ts;

    checkinBtn.style.display = "none";
    resetBtn.style.display   = "block";
  }

  function setNotCheckedInUI(){
    statusPill.classList.remove("pill-ok");
    statusPill.classList.add("pill-warn");
    statusText.textContent = "æœªãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³";
    statusSub.textContent  = "å—ä»˜ã§æ¡ˆå†…ãŒã‚ã£ãŸæ–¹ã¯ã€Œãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„";

    checkedAt.textContent = "â€”";

    checkinBtn.style.display = "block";
    resetBtn.style.display   = "none";
  }

  function getStoreUrl(){
    const ua = navigator.userAgent || "";
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isAndroid = /Android/i.test(ua);

    if(isIOS) return STORE_URL_IOS;
    if(isAndroid) return STORE_URL_ANDROID;
    return STORE_URL_WEB; // PCãªã©
  }

  function openStore(){
    const url = getStoreUrl();
    try{
      if(window.liff && typeof liff.openWindow === "function"){
        liff.openWindow({ url, external: true });
        return;
      }
    }catch(e){ /* ignore */ }
    window.location.href = url;
  }

  function cancelAutoRedirect(){
    if(redirectTimer){ clearTimeout(redirectTimer); redirectTimer = null; }
    if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
  }

  function showInstallGateAndRedirect(){
    installGate.style.display = "block";

    // âœ… 3ç§’è¡¨ç¤ºã«åˆã‚ã›ã¦ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚‚ 3 ã«
    let cd = 3;
    cdEl.textContent = String(cd);

    countdownTimer = setInterval(()=>{
      cd -= 1;
      cdEl.textContent = String(Math.max(cd, 0));
      if(cd <= 0){
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
    }, 1000);

    // âœ… 3ç§’å¾Œã«ã‚¹ãƒˆã‚¢ã¸
    redirectTimer = setTimeout(()=>{
      openStore();
    }, 3000);
  }

  // åˆæœŸè¡¨ç¤º
  (function init(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){ setNotCheckedInUI(); return; }
    try{
      const data = JSON.parse(raw);
      if(data && data.checkedAt){
        setCheckedInUI(data.checkedAt);
      }else{
        setNotCheckedInUI();
      }
    }catch{
      setNotCheckedInUI();
    }
  })();

  // âœ… ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼ˆæŠ¼ä¸‹ç›´å¾Œï¼šå…¨ç”»é¢è¨´æ±‚ â†’ ã‚¹ãƒˆã‚¢ã¸ï¼‰
  checkinBtn.addEventListener("click", ()=>{
    if(locked) return;
    locked = true;

    const ts = nowText();
    saveCheckedIn(ts);
    setCheckedInUI(ts);

    // ã‚¢ãƒ©ãƒ¼ãƒˆã¯å‡ºã•ãªã„ï¼ˆã‚¹ãƒˆã‚¢é·ç§»ã‚’é‚ªé­”ã™ã‚‹ã®ã§ï¼‰
    showInstallGateAndRedirect();

    // äºŒé‡ã‚¿ãƒƒãƒ—å¯¾ç­–ï¼šå°‘ã—å¾Œã«è§£é™¤
    setTimeout(()=>{ locked = false; }, 1500);
  });

  // ãƒ¢ãƒƒã‚¯ï¼šæœªãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã«æˆ»ã™
  resetBtn.addEventListener("click", ()=>{
    cancelAutoRedirect();
    installGate.style.display = "none";
    clearCheckedIn();
    setNotCheckedInUI();
    alert("æœªãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã«æˆ»ã—ã¾ã—ãŸï¼ˆãƒ¢ãƒƒã‚¯ï¼‰ã€‚");
  });

  // ã‚¹ãƒˆã‚¢ã¸é€²ã‚€ï¼ˆæ‰‹å‹•ï¼‰
  goStoreBtn.addEventListener("click", ()=>{
    cancelAutoRedirect();
    openStore();
  });

  // ä»Šã¯ã—ãªã„ï¼ˆè‡ªå‹•é·ç§»ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦é–‰ã˜ã‚‹ï¼‰
  skipBtn.addEventListener("click", ()=>{
    cancelAutoRedirect();
    installGate.style.display = "none";
  });
</script>
</body>
</html>
