<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>チェックイン</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --radius:16px;

      --shadow: 0 10px 28px rgba(17,24,39,.08);
      --primary:#111827;
      --blue:#2563eb;
      --ok:#16a34a;
      --warn:#b45309;
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== 共通ヘッダー ===== */
    .header{
      height:64px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      border-bottom:1px solid var(--line);
      padding:0 16px;
      background:#fff;
    }
    .header-title{
      grid-column:2;
      font-size:22px;
      font-weight:900;
      text-align:center;
    }
    .header-home{
      grid-column:3;
      justify-self:end;
      font-size:18px;
      font-weight:800;
      text-decoration:none;
      color: var(--blue);
    }

    /* ===== コンテンツ ===== */
    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      background:#fff;
      box-shadow: var(--shadow);
    }

    .card-title{
      font-size:18px;
      font-weight:900;
      margin:0 0 12px;
    }

    /* ステータス */
    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      font-weight:900;
      font-size:14px;
      background:#fff;
    }
    .dot{ width:10px;height:10px;border-radius:999px; }
    .pill-warn .dot{ background: var(--warn); box-shadow: 0 0 0 6px rgba(180,83,9,.14); }
    .pill-ok   .dot{ background: var(--ok);   box-shadow: 0 0 0 6px rgba(22,163,74,.14); }

    .btns{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      border-radius:16px;
      padding:16px 16px;
      font-weight:900;
      font-size:18px;
      min-height:56px;
      box-shadow: var(--shadow);
      background: var(--primary);
      color:#fff;
      text-align:center;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.secondary{
      background:#fff;
      color: var(--text);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:800;
    }

    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    /* 受付状態（変更不要と言われた部分：見た目は維持） */
    .kv{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .row{
      display:flex;
      flex-direction:column;
      gap:6px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .label{
      font-size:13px;
      color:var(--muted);
      font-weight:800;
    }
    .value{
      font-size:20px;
      font-weight:900;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    /* QRデモ（チェックイン後に表示） */
    .qrWrap{ display:none; margin-top:12px; }
    .qrBox{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius:16px;
      border:1px dashed #d1d5db;
      display:grid;
      place-items:center;
      background: radial-gradient(circle at 20% 20%, #fff 0%, #f9fafb 45%, #fff 100%);
      overflow:hidden;
    }
    .qrBox svg{ width:88%; height:88%; }

    .hint{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
    }
  </style>
</head>

<body>
  <!-- 共通ヘッダー -->
  <header class="header">
    <div></div>
    <div class="header-title">チェックイン</div>
    <a class="header-home" href="./index.html">ホーム</a>
  </header>

  <div class="wrap">

    <!-- 状態 -->
    <section class="card">
      <div class="card-title">状態</div>

      <div id="statusPill" class="status-pill pill-warn">
        <span class="dot"></span>
        <span id="statusText">未チェックイン</span>
      </div>

      <div class="btns">
        <button class="btn" id="checkinBtn">チェックインする</button>
        <button class="btn secondary" id="scanBtn">QRを読み取る</button>
      </div>

      <div class="hint">
        ※チェックイン後は「チェックインする」は押せなくなります。
      </div>
    </section>

    <!-- 受付状態（内容は変更不要） -->
    <section class="card">
      <div class="card-title">受付状態</div>

      <div class="kv">
        <div class="row">
          <div class="label">チェックイン時刻</div>
          <div class="value" id="checkedAt">—</div>
        </div>

        <div class="row">
          <div class="label">受付番号（デモ）</div>
          <div class="value mono" id="ticketNo">—</div>
        </div>
      </div>

      <!-- チェックイン後にQRデモ表示 -->
      <div class="qrWrap" id="qrWrap">
        <div class="hint" style="margin-bottom:8px;">当日QR（デモ）</div>
        <div class="qrBox" aria-label="QR demo">
          <svg viewBox="0 0 100 100" role="img" aria-label="QR">
            <rect x="0" y="0" width="100" height="100" fill="white"/>
            <g fill="#111827">
              <rect x="8" y="8" width="26" height="26" rx="3"/>
              <rect x="66" y="8" width="26" height="26" rx="3"/>
              <rect x="8" y="66" width="26" height="26" rx="3"/>
              <rect x="13" y="13" width="16" height="16" fill="white" rx="2"/>
              <rect x="71" y="13" width="16" height="16" fill="white" rx="2"/>
              <rect x="13" y="71" width="16" height="16" fill="white" rx="2"/>
              <rect x="17" y="17" width="8" height="8" rx="1"/>
              <rect x="75" y="17" width="8" height="8" rx="1"/>
              <rect x="17" y="75" width="8" height="8" rx="1"/>

              <rect x="40" y="40" width="6" height="6"/>
              <rect x="48" y="40" width="6" height="6"/>
              <rect x="56" y="40" width="6" height="6"/>
              <rect x="40" y="48" width="6" height="6"/>
              <rect x="52" y="48" width="6" height="6"/>
              <rect x="60" y="48" width="6" height="6"/>
              <rect x="40" y="56" width="6" height="6"/>
              <rect x="48" y="56" width="6" height="6"/>
              <rect x="56" y="56" width="6" height="6"/>
            </g>
            <text x="50" y="97" text-anchor="middle" font-size="7" fill="#6b7280">DEMO</text>
          </svg>
        </div>
      </div>
    </section>

  </div>

  <script>
    // ===== デモ状態保存 =====
    const LS_KEY = "miniapp_checkin_done";

    const statusPill = document.getElementById("statusPill");
    const statusText = document.getElementById("statusText");
    const checkinBtn = document.getElementById("checkinBtn");

    const checkedAt = document.getElementById("checkedAt");
    const ticketNo  = document.getElementById("ticketNo");
    const qrWrap    = document.getElementById("qrWrap");

    function pad(n){ return String(n).padStart(2,"0"); }

    function setCheckedInUI(data){
      // ステータス
      statusPill.classList.remove("pill-warn");
      statusPill.classList.add("pill-ok");
      statusText.textContent = "チェックイン済み";

      // ボタン非活性
      checkinBtn.disabled = true;

      // 受付状態（内容は変更不要：値だけ入れる）
      checkedAt.textContent = data.checkedAt;
      ticketNo.textContent  = data.ticketNo;

      // QRデモ表示（チェックイン後のみ）
      qrWrap.style.display = "block";
    }

    function setNotCheckedInUI(){
      statusPill.classList.remove("pill-ok");
      statusPill.classList.add("pill-warn");
      statusText.textContent = "未チェックイン";

      checkinBtn.disabled = false;
      checkedAt.textContent = "—";
      ticketNo.textContent  = "—";
      qrWrap.style.display  = "none";
    }

    function doCheckin(source){
      const now = new Date();
      const ts = `${now.getFullYear()}/${pad(now.getMonth()+1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
      const tno = `C-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}`;

      const data = { checkedAt: ts, ticketNo: tno, source };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      setCheckedInUI(data);
    }

    // 初期表示（保存状態を復元）
    (function init(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){ setNotCheckedInUI(); return; }
      try{
        const data = JSON.parse(raw);
        setCheckedInUI(data);
      }catch{
        setNotCheckedInUI();
      }
    })();

    // チェックインする
    checkinBtn.addEventListener("click", ()=>{
      doCheckin("manual");
      alert("チェックインしました（デモ）。");
    });

    // QRを読み取る（LIFFがあればscan、なければデモ）
    document.getElementById("scanBtn").addEventListener("click", async ()=>{
      // すでにチェックイン済みならスキャンだけしてもOK（仕様は決めてないので警告だけ）
      // ※ここは要望があれば変更します
      if(window.liff){
        try{
          if(typeof liff.scanCodeV2 === "function"){
            const res = await liff.scanCodeV2();
            doCheckin("scan:" + (res?.value ? String(res.value).slice(0,24) : "unknown"));
            alert("QRを読み取りました（デモ）。");
            return;
          }
          if(typeof liff.scanCode === "function"){
            const res = await liff.scanCode();
            doCheckin("scan:" + (res ? String(res).slice(0,24) : "unknown"));
            alert("QRを読み取りました（デモ）。");
            return;
          }
          alert("この環境ではQR読取が有効ではありません。");
        }catch(e){
          console.log(e);
          alert("QR読取に失敗しました。");
        }
      } else {
        // Web/PCなど：デモ扱い
        doCheckin("scan:demo");
        alert("QRを読み取りました（デモ）。");
      }
    });
  </script>
</body>
</html>
