<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>チェックイン</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --radius:16px;

      --shadow: 0 10px 28px rgba(17,24,39,.08);
      --primary:#111827;
      --blue:#2563eb;
      --ok:#16a34a;
      --warn:#b45309;
      --soft:#f9fafb;
    }
    * , *::before, *::after { box-sizing: border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== 共通ヘッダー ===== */
    .header{
      height:64px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      border-bottom:1px solid var(--line);
      padding:0 16px;
      background:#fff;
    }
    .header-title{
      grid-column:2;
      font-size:22px;
      font-weight:900;
      text-align:center;
    }
    .header-home{
      grid-column:3;
      justify-self:end;
      font-size:18px;
      font-weight:800;
      text-decoration:none;
      color: var(--blue);
    }

    /* ===== コンテンツ ===== */
    .wrap{
      max-width:520px;
      margin:0 auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      background:#fff;
      box-shadow: var(--shadow);
    }

    .card-title{
      font-size:18px;
      font-weight:900;
      margin:0 0 12px;
    }

    /* ステータス */
    .status-pill{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      font-weight:900;
      background: var(--soft);
    }
    .status-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dot{ width:12px;height:12px;border-radius:999px; flex:0 0 auto; }
    .pill-warn .dot{ background: var(--warn); box-shadow: 0 0 0 7px rgba(180,83,9,.14); }
    .pill-ok   .dot{ background: var(--ok);   box-shadow: 0 0 0 7px rgba(22,163,74,.14); }

    .status-text{
      font-size:18px;
      font-weight:1000;
      letter-spacing:.02em;
      white-space:nowrap;
    }
    .status-sub{
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      margin-top:2px;
      line-height:1.55;
    }

    .status-meta{
      text-align:right;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.3;
    }

    .btns{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }

    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      border-radius:16px;
      padding:16px 16px;
      font-weight:900;
      font-size:18px;
      min-height:56px;
      box-shadow: var(--shadow);
      background: var(--primary);
      color:#fff;
      text-align:center;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.secondary{
      background:#fff;
      color: var(--text);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:900;
    }

    .btn.blue{
      background: var(--blue);
    }

    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .hint{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      line-height:1.6;
    }

    /* ===== 強制モーダル（閉じられない） ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(17,24,39,.60);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal-top{
      display:flex;
      align-items:flex-start;
      gap:12px;
    }
    .app-icon{
      width:44px; height:44px;
      border-radius:12px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff 0%, #f3f4f6 100%);
      display:grid;
      place-items:center;
      font-weight:1000;
      flex:0 0 auto;
    }
    .modal-title{
      font-size:18px;
      font-weight:1000;
      margin:0;
    }
    .modal-desc{
      margin:6px 0 0;
      color:var(--muted);
      font-weight:800;
      font-size:14px;
      line-height:1.7;
    }
    .modal-points{
      margin:12px 0 0;
      padding-left:18px;
      color:var(--text);
      font-weight:900;
    }
    .modal-points li{
      margin:6px 0;
      font-size:14px;
      font-weight:900;
    }
    .modal-actions{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
  </style>
</head>

<body>
  <header class="header">
    <div></div>
    <div class="header-title">チェックイン</div>
    <a class="header-home" href="./index.html">ホーム</a>
  </header>

  <div class="wrap">

    <!-- 最上部：チェックイン状態 -->
    <section class="card">
      <div class="card-title">チェックイン状態</div>

      <div id="statusPill" class="status-pill pill-warn">
        <div class="status-left">
          <span class="dot"></span>
          <div>
            <div id="statusText" class="status-text">未チェックイン</div>
            <div id="statusSub" class="status-sub">
              受付で案内があった方は「チェックインする」を押してください
            </div>
          </div>
        </div>

        <div class="status-meta">
          <div>チェックイン時刻</div>
          <div id="checkedAt">—</div>
        </div>
      </div>

      <div class="btns">
        <button class="btn" id="checkinBtn">チェックインする</button>
        <button class="btn secondary" id="resetBtn" style="display:none;">未チェックインに戻す（モック）</button>
      </div>

      <div class="hint">
        ※チェックイン完了後、アプリの案内画面へ進みます。
      </div>
    </section>

  </div>

  <!-- ✅ 強制：アプリ誘導モーダル（閉じられない） -->
  <div class="modal-backdrop" id="installModal" role="dialog" aria-modal="true" aria-label="アプリのご案内">
    <div class="modal">
      <div class="modal-top">
        <div class="app-icon" aria-hidden="true">ア</div>
        <div>
          <h3 class="modal-title">アプリへ進んでください</h3>
          <p class="modal-desc">
            チェックインが完了しました。<br/>
            当日のご案内と便利機能のため、アプリを開く／入手してください。
          </p>
        </div>
      </div>

      <ul class="modal-points">
        <li>無料Wi-Fiに接続しやすい</li>
        <li>モバイルオーダーが使える（対応している場合）</li>
        <li>案内やお知らせを見逃しにくい</li>
      </ul>

      <div class="modal-actions">
        <button class="btn blue" id="modalInstallBtn">アプリを開く／入手する</button>
      </div>

      <div class="hint" style="margin-top:10px;">
        ※アプリは端末のストア画面へ移動します（モックではアラート表示）。
      </div>
    </div>
  </div>

  <script>
    // ===== デモ状態保存 =====
    const LS_KEY = "miniapp_checkin_done_force";

    const statusPill = document.getElementById("statusPill");
    const statusText = document.getElementById("statusText");
    const statusSub  = document.getElementById("statusSub");
    const checkinBtn = document.getElementById("checkinBtn");
    const resetBtn   = document.getElementById("resetBtn");

    const checkedAt  = document.getElementById("checkedAt");

    const installModal = document.getElementById("installModal");
    const modalInstallBtn = document.getElementById("modalInstallBtn");

    function pad(n){ return String(n).padStart(2,"0"); }

    function nowText(){
      const now = new Date();
      return `${now.getFullYear()}/${pad(now.getMonth()+1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
    }

    function lockBackgroundScroll(lock){
      // LINE WebViewでも効くように簡易ロック
      document.body.style.overflow = lock ? "hidden" : "";
    }

    function openInstallModal(){
      installModal.style.display = "flex";
      lockBackgroundScroll(true);
    }

    function closeInstallModal(){
      // 強制要件のため、基本は閉じない（将来要件が変わった時用）
      installModal.style.display = "none";
      lockBackgroundScroll(false);
    }

    function setCheckedInUI(ts){
      statusPill.classList.remove("pill-warn");
      statusPill.classList.add("pill-ok");
      statusText.textContent = "チェックイン済み";
      statusSub.textContent  = "アプリの案内画面が表示されています。";

      checkedAt.textContent = ts;

      checkinBtn.style.display = "none";
      resetBtn.style.display   = "block";

      // ✅ チェックイン後は強制的にモーダル表示
      openInstallModal();
    }

    function setNotCheckedInUI(){
      statusPill.classList.remove("pill-ok");
      statusPill.classList.add("pill-warn");
      statusText.textContent = "未チェックイン";
      statusSub.textContent  = "受付で案内があった方は「チェックインする」を押してください";

      checkedAt.textContent = "—";

      checkinBtn.style.display = "block";
      resetBtn.style.display   = "none";

      // 未チェックイン時はモーダル非表示
      closeInstallModal();
    }

    function saveCheckedIn(ts){
      localStorage.setItem(LS_KEY, JSON.stringify({ checkedAt: ts }));
    }
    function clearCheckedIn(){
      localStorage.removeItem(LS_KEY);
    }

    // 初期表示
    (function init(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){ setNotCheckedInUI(); return; }
      try{
        const data = JSON.parse(raw);
        if(data && data.checkedAt){
          setCheckedInUI(data.checkedAt);
        }else{
          setNotCheckedInUI();
        }
      }catch{
        setNotCheckedInUI();
      }
    })();

    // チェックイン
    checkinBtn.addEventListener("click", ()=>{
      const ts = nowText();
      saveCheckedIn(ts);
      setCheckedInUI(ts);
      alert("チェックインが完了しました。");
    });

    // モック：未チェックインに戻す（ただしモーダルが出ているので通常は触れない）
    resetBtn.addEventListener("click", ()=>{
      clearCheckedIn();
      setNotCheckedInUI();
      alert("未チェックインに戻しました（モック）。");
    });

    // アプリ導線（モック）
    modalInstallBtn.addEventListener("click", ()=>{
      // 実装時：OS判定してストアURL or ディープリンクへ
      // iOS例: location.href = "itms-apps://apps.apple.com/app/idXXXXXXXX";
      // Android例: location.href = "market://details?id=xxxxxxxx";
      alert("（モック）ストア／アプリ起動へ遷移します。");

      // 強制運用なら、実装時はここで必ず遷移させる
      // location.href = "...";
    });

    // ✅ 背景クリックで閉じない（強制）
    installModal.addEventListener("click", (e)=>{
      // backdropクリックでも閉じない
      e.stopPropagation();
    });
  </script>
</body>
</html>
