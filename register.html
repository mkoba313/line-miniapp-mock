<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>火葬申込み</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#111827;
      --card:#ffffff;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --radius:16px;
      --font: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Arial, sans-serif;
    }
    * , *::before, *::after{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--font);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    header{
      position:sticky;
      top:0;
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:12px 16px;
      z-index:10;
    }
    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      max-width:780px;
      margin:0 auto;
    }
    .brand{ font-weight:800; font-size:18px; letter-spacing:.02em; white-space:nowrap; }
    .title{
      font-weight:900;
      font-size:18px;
      text-align:center;
      flex:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .seg{
      display:flex; gap:4px; align-items:center;
      background:#fff; border:1px solid var(--border);
      border-radius:12px; padding:4px; white-space:nowrap;
    }
    .seg a{
      text-decoration:none;
      border:1px solid transparent;
      background:#fff;
      padding:6px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:900;
      color:var(--text);
    }
    .seg a.active{ background:var(--primary); color:#fff; border-color:var(--primary); }

    main{ max-width:780px; margin:0 auto; padding:16px; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:14px;
    }
    .section-title{ font-weight:800; font-size:18px; margin:0 0 10px 0; }
    label{ display:block; font-weight:700; margin:12px 0 6px 0; font-size:16px; }
    input[type="text"], input[type="tel"], input[type="email"]{
      display:block; width:100%; max-width:100%;
      font-size:18px; padding:14px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      -webkit-appearance:none; appearance:none;
      background:#fff;
    }
    input[type="text"]:focus, input[type="tel"]:focus, input[type="email"]:focus{ border-color:#9ca3af; }
    .note{ color:var(--muted); font-size:14px; margin-top:6px; }

    /* 利用区分（任意）：喪主以外のみ */
    .opt-row{
      margin-top:8px;
      padding:14px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      display:flex;
      gap:10px;
      align-items:flex-start;
      cursor:pointer;
    }
    .opt-row input[type="checkbox"]{
      width:22px; height:22px; margin-top:2px;
      accent-color:#111827; flex:0 0 auto;
    }
    .opt-title{ font-weight:900; font-size:16px; line-height:1.2; }
    .opt-sub{ margin-top:4px; font-size:13px; color:var(--muted); font-weight:700; line-height:1.45; }
    .opt-row:has(input:checked){
      border-color:#9ca3af;
      box-shadow:0 0 0 3px rgba(17,24,39,.06);
    }

    /* 喪主情報（喪主以外のときだけ表示） */
    .chief-box{
      margin-top:12px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fafafa;
      display:none;
    }
    .chief-title{ font-weight:900; margin:0 0 6px 0; font-size:15px; }
    .chief-sub{ margin:0 0 10px 0; color:var(--muted); font-size:13px; font-weight:700; }

    /* 生年月日 */
    .dob-grid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:6px; }
    @media (max-width: 520px){ .dob-grid{ grid-template-columns: 1fr; } }
    .select{
      width:100%; max-width:100%;
      font-size:18px; padding:14px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      outline:none;
      -webkit-appearance:none; appearance:none;
    }
    .select:focus{ border-color:#9ca3af; }
    .select-wrap{ position:relative; }
    .select-wrap::after{
      content:"▾";
      position:absolute;
      right:12px;
      top:50%;
      transform:translateY(-50%);
      color:#9ca3af;
      font-size:16px;
      pointer-events:none;
    }

    details{ border:1px solid var(--border); border-radius:14px; padding:10px 12px; background:#fff; }
    details + details{ margin-top:10px; }
    summary{ cursor:pointer; font-weight:800; font-size:16px; list-style:none; }
    summary::-webkit-details-marker{ display:none; }
    .summary-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .badge{
      font-size:12px; color:#fff; background:#ef4444;
      padding:2px 8px; border-radius:999px; font-weight:800; flex:0 0 auto;
    }

    /* ✅ スクロールボックス（LIFF/iPhone対策つき） */
    .scrollbox{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      height:180px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:12px;
      font-size:14px;
      background:#fafafa;
    }
    .scroll-hint{ margin-top:8px; font-size:13px; color:var(--muted); }
    .agree-row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed var(--border);
    }
    input[type="checkbox"]{ width:22px; height:22px; margin-top:2px; accent-color:#111827; }
    .checkbox-label{ font-size:16px; font-weight:800; }
    .checkbox-sub{ font-size:13px; color:var(--muted); margin-top:2px; }

    .cta{ display:grid; gap:10px; }
    button{
      width:100%;
      font-size:18px;
      font-weight:900;
      padding:14px 12px;
      border:none;
      border-radius:14px;
      cursor:pointer;
      background:var(--primary);
      color:#fff;
    }
    button:disabled{ cursor:not-allowed; background:#d1d5db; color:#6b7280; }
  </style>
</head>

<body>
<header>
  <div class="header-row">
    <div class="brand">喪主の力</div>
    <div class="title">火葬申込み</div>
    <div class="seg" aria-label="申込み種別切替">
      <a class="active" href="./register.html">火葬申込み</a>
      <a href="./participant_register.html">参加申込み</a>
    </div>
  </div>
</header>

<main>
  <form id="registerForm" class="card" onsubmit="return false;">
    <h2 class="section-title">会員登録（火葬申込み）</h2>

    <label>利用区分（任意）</label>
    <label class="opt-row" for="roleOther">
      <input id="roleOther" type="checkbox" />
      <div>
        <div class="opt-title">喪主以外</div>
        <div class="opt-sub">※喪主の方以外が申込む場合はチェックしてください（喪主情報の入力が必要になります）</div>
      </div>
    </label>

    <div id="chiefBox" class="chief-box" aria-live="polite">
      <p class="chief-title">喪主の情報（必須）</p>
      <p class="chief-sub">※「喪主以外」を選択した場合のみ入力してください。</p>

      <label for="chiefName">喪主氏名（必須）</label>
      <input id="chiefName" name="chiefName" type="text" placeholder="例：山田 太郎" autocomplete="name" />

      <label for="chiefKana">喪主氏名（ふりがな）（必須）</label>
      <input id="chiefKana" name="chiefKana" type="text" placeholder="例：やまだ たろう" inputmode="kana" autocomplete="off" />
    </div>

    <label for="name">申込者氏名（必須）</label>
    <input id="name" name="name" type="text" placeholder="例：山田 太郎" autocomplete="name" required />

    <label for="nameKana">申込者氏名（ふりがな）（必須）</label>
    <input id="nameKana" name="nameKana" type="text" placeholder="例：やまだ たろう" inputmode="kana" autocomplete="off" required />

    <label>生年月日（必須）</label>
    <div class="dob-grid" aria-label="生年月日">
      <div class="select-wrap">
        <select id="birthYear" class="select" required>
          <option value="" selected disabled>年</option>
        </select>
      </div>
      <div class="select-wrap">
        <select id="birthMonth" class="select" required>
          <option value="" selected disabled>月</option>
        </select>
      </div>
      <div class="select-wrap">
        <select id="birthDay" class="select" required>
          <option value="" selected disabled>日</option>
        </select>
      </div>
    </div>
    <input type="hidden" id="birthday" name="birthday" />

    <label for="tel">電話番号（必須）</label>
    <input id="tel" name="tel" type="tel" placeholder="例：09012345678" autocomplete="tel" required />

    <label for="address">住所（必須）</label>
    <input id="address" name="address" type="text" placeholder="例：東京都〇〇区…" autocomplete="street-address" required />

    <label for="email">メールアドレス（任意）</label>
    <input id="email" name="email" type="email" placeholder="例：example@example.com" autocomplete="email" />
    <p class="note">※確認連絡のために入力いただく場合があります（任意）。</p>

    <p class="note">※入力項目は今後増える可能性があります。</p>
  </form>

  <div class="card">
    <h3 class="section-title">同意事項</h3>

    <div class="agree-row" style="border-top:none; padding-top:0;">
      <input id="allAgree" type="checkbox" />
      <div>
        <div class="checkbox-label">すべての規約に同意する</div>
        <div class="checkbox-sub">※このチェックを入れる場合は、スクロールせずに同意できます。</div>
      </div>
    </div>

    <div style="height:10px;"></div>

    <!-- 1) 火葬の規約 -->
    <details open>
      <summary>
        <div class="summary-row">
          <span>火葬の規約（必須）</span>
          <span class="badge">必須</span>
        </div>
      </summary>

      <div id="cremationScroll" class="scrollbox" aria-label="火葬の規約（必須）">
        <p><strong>【火葬の規約】</strong></p>
        <p>本規約は、火葬申込みに関する手続き・利用条件・注意事項を定めるものです。</p>
        <p>（以下はダミー文です。正式な規約文に差し替えてください）</p>
        <p>1. 申込み内容は正確に入力してください。</p>
        <p>2. 変更・取消は斎場の運用ルールに従います。</p>
        <p>3. 通信障害等により申込みが正常に行えない場合があります。</p>
        <p>4. その他、運営上必要な事項は斎場が定めます。</p>
        <p>5. 追加条項（ダミー）</p>
        <p>6. 追加条項（ダミー）</p>
        <p>7. 追加条項（ダミー）</p>
        <p>8. 追加条項（ダミー）</p>
      </div>

      <div id="cremationHint" class="scroll-hint">※最後までスクロールするとチェックできます。</div>

      <div class="agree-row">
        <input id="cremationAgree" type="checkbox" disabled />
        <div>
          <div class="checkbox-label">「火葬の規約」に同意します</div>
        </div>
      </div>
    </details>

    <!-- 2) 個人情報の規約 -->
    <details>
      <summary>
        <div class="summary-row">
          <span>個人情報の規約（必須）</span>
          <span class="badge">必須</span>
        </div>
      </summary>

      <div id="privacyScroll" class="scrollbox" aria-label="個人情報の規約（必須）">
        <p><strong>【個人情報の規約】</strong></p>
        <p>（以下はダミー文です。正式な規約文に差し替えてください）</p>
        <p>1. 取得する情報：氏名、ふりがな、生年月日、電話番号、住所、メールアドレス（任意） 等</p>
        <p>2. 利用目的：申込み受付、本人確認、連絡、運営上必要な案内、問合せ対応 等</p>
        <p>3. 第三者提供：法令に基づく場合等を除き、本人同意なく提供しません。</p>
        <p>4. 安全管理：不正アクセス等の防止に努めます。</p>
        <p>5. 追加条項（ダミー）</p>
        <p>6. 追加条項（ダミー）</p>
        <p>7. 追加条項（ダミー）</p>
        <p>8. 追加条項（ダミー）</p>
      </div>

      <div id="privacyHint" class="scroll-hint">※最後までスクロールするとチェックできます。</div>

      <div class="agree-row">
        <input id="privacyAgree" type="checkbox" disabled />
        <div>
          <div class="checkbox-label">「個人情報の規約」に同意します</div>
        </div>
      </div>
    </details>

    <!-- 3) 葬儀ミニアプリの規約 -->
    <details>
      <summary>
        <div class="summary-row">
          <span>葬儀ミニアプリの規約（必須）</span>
          <span class="badge">必須</span>
        </div>
      </summary>

      <div id="miniappScroll" class="scrollbox" aria-label="葬儀ミニアプリの規約（必須）">
        <p><strong>【葬儀ミニアプリの規約】</strong></p>
        <p><strong>■ご利用メリット</strong></p>
        <ul>
          <li><strong>無料Wi-Fi接続</strong>：斎場内で通信環境が不安な場合でも使いやすくなります。</li>
          <li><strong>モバイルオーダー</strong>：売店や対象サービスをスマホからスムーズに注文できます。</li>
        </ul>
        <p>（以下はダミー文です。正式な規約文に差し替えてください）</p>
        <p>1. 提供機能：館内案内、通知、（対象の場合）モバイルオーダー等</p>
        <p>2. 利用上の注意：端末・通信環境により一部機能が利用できない場合があります。</p>
        <p>3. 禁止事項：不正利用、なりすまし、サービス妨害 等</p>
        <p>4. 免責：システム障害等により機能が利用できない場合があります。</p>
        <p>5. 追加条項（ダミー）</p>
        <p>6. 追加条項（ダミー）</p>
        <p>7. 追加条項（ダミー）</p>
      </div>

      <div id="miniappHint" class="scroll-hint">※最後までスクロールするとチェックできます。</div>

      <div class="agree-row">
        <input id="miniappAgree" type="checkbox" disabled />
        <div>
          <div class="checkbox-label">「葬儀ミニアプリの規約」に同意します</div>
          <div class="checkbox-sub">※無料Wi-Fi接続／モバイルオーダー等が利用できます。</div>
        </div>
      </div>
    </details>
  </div>

  <div class="card cta">
    <button id="submitBtn" type="button" disabled>登録</button>
    <p class="note" style="margin:0;">※「登録」は、3つの規約への同意がそろった時点で押せます。</p>
  </div>
</main>

<script>
  // ===== 喪主以外チェックで喪主情報を表示＆必須化 =====
  const roleOther = document.getElementById("roleOther");
  const chiefBox  = document.getElementById("chiefBox");
  const chiefName = document.getElementById("chiefName");
  const chiefKana = document.getElementById("chiefKana");

  function setChiefRequired(isRequired){
    chiefName.required = isRequired;
    chiefKana.required = isRequired;
  }
  function onRoleOtherChange(){
    const isOther = roleOther.checked;
    chiefBox.style.display = isOther ? "block" : "none";
    setChiefRequired(isOther);
    if(!isOther){
      chiefName.value = "";
      chiefKana.value = "";
    }
  }
  roleOther.addEventListener("change", onRoleOtherChange);
  onRoleOtherChange();

  // ===== 生年月日：年/月/日を生成 =====
  const birthYear  = document.getElementById("birthYear");
  const birthMonth = document.getElementById("birthMonth");
  const birthDay   = document.getElementById("birthDay");
  const birthdayHidden = document.getElementById("birthday");

  function fillYears(){
    const now = new Date();
    const thisYear = now.getFullYear();
    for(let y = thisYear; y >= 1900; y--){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = `${y}年`;
      birthYear.appendChild(opt);
    }
  }
  function fillMonths(){
    for(let m=1; m<=12; m++){
      const opt = document.createElement("option");
      opt.value = String(m);
      opt.textContent = `${m}月`;
      birthMonth.appendChild(opt);
    }
  }
  function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }
  function rebuildDays(){
    birthDay.querySelectorAll("option:not([disabled])").forEach(o=>o.remove());
    const y = parseInt(birthYear.value,10);
    const m = parseInt(birthMonth.value,10);
    if(!y || !m) return;
    const max = daysInMonth(y,m);
    for(let d=1; d<=max; d++){
      const opt = document.createElement("option");
      opt.value = String(d);
      opt.textContent = `${d}日`;
      birthDay.appendChild(opt);
    }
  }
  function syncHidden(){
    const y = birthYear.value, m = birthMonth.value, d = birthDay.value;
    if(y && m && d){
      birthdayHidden.value = `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    }else birthdayHidden.value = "";
  }
  fillYears(); fillMonths();
  birthYear.addEventListener("change", ()=>{ rebuildDays(); birthDay.value=""; syncHidden(); });
  birthMonth.addEventListener("change", ()=>{ rebuildDays(); birthDay.value=""; syncHidden(); });
  birthDay.addEventListener("change", syncHidden);

  // ===== 同意UI（3規約） =====
  const allAgree = document.getElementById('allAgree');

  const cremationScroll = document.getElementById('cremationScroll');
  const privacyScroll   = document.getElementById('privacyScroll');
  const miniappScroll   = document.getElementById('miniappScroll');

  const cremationAgree = document.getElementById('cremationAgree');
  const privacyAgree   = document.getElementById('privacyAgree');
  const miniappAgree   = document.getElementById('miniappAgree');

  const cremationHint = document.getElementById('cremationHint');
  const privacyHint   = document.getElementById('privacyHint');
  const miniappHint   = document.getElementById('miniappHint');

  const submitBtn = document.getElementById('submitBtn');

  let cremationUnlockedByScroll = false;
  let privacyUnlockedByScroll = false;
  let miniappUnlockedByScroll = false;

  function nearBottom(el) {
    return el.scrollTop + el.clientHeight >= el.scrollHeight - 5;
  }

  // ✅ スクロールできない（内容が短い）場合は「読める」扱いで解放
  function unlockIfNoScroll(el, unlockedSetter){
    if(el.scrollHeight <= el.clientHeight + 2){
      unlockedSetter(true);
    }
  }

  function updateButtonState() {
    submitBtn.disabled = !(cremationAgree.checked && privacyAgree.checked && miniappAgree.checked);
  }

  function syncMasterFromIndividuals() {
    allAgree.checked = (cremationAgree.checked && privacyAgree.checked && miniappAgree.checked);
  }

  function applyMasterAgree(isOn) {
    if (isOn) {
      cremationAgree.disabled = false;
      privacyAgree.disabled = false;
      miniappAgree.disabled = false;

      cremationAgree.checked = true;
      privacyAgree.checked = true;
      miniappAgree.checked = true;

      cremationHint.textContent = "※「すべて同意」を選択中のため、スクロール不要です。";
      privacyHint.textContent   = "※「すべて同意」を選択中のため、スクロール不要です。";
      miniappHint.textContent   = "※「すべて同意」を選択中のため、スクロール不要です。";
    } else {
      cremationAgree.checked = false;
      privacyAgree.checked = false;
      miniappAgree.checked = false;

      cremationAgree.disabled = !cremationUnlockedByScroll;
      privacyAgree.disabled   = !privacyUnlockedByScroll;
      miniappAgree.disabled   = !miniappUnlockedByScroll;

      cremationHint.textContent = cremationUnlockedByScroll ? "※スクロール済みです。チェックできます。" : "※最後までスクロールするとチェックできます。";
      privacyHint.textContent   = privacyUnlockedByScroll ? "※スクロール済みです。チェックできます。" : "※最後までスクロールするとチェックできます。";
      miniappHint.textContent   = miniappUnlockedByScroll ? "※スクロール済みです。チェックできます。" : "※最後までスクロールするとチェックできます。";
    }
    updateButtonState();
  }

  function tryUnlock(el, masterChecked, setUnlocked, checkbox, hint){
    if(masterChecked) return;
    if(nearBottom(el)){
      setUnlocked(true);
      checkbox.disabled = false;
      hint.textContent = "※スクロール済みです。チェックできます。";
    }
  }

  // init unlock check
  unlockIfNoScroll(cremationScroll, (v)=>{ cremationUnlockedByScroll=v; });
  unlockIfNoScroll(privacyScroll,   (v)=>{ privacyUnlockedByScroll=v; });
  unlockIfNoScroll(miniappScroll,   (v)=>{ miniappUnlockedByScroll=v; });

  cremationAgree.disabled = !cremationUnlockedByScroll;
  privacyAgree.disabled   = !privacyUnlockedByScroll;
  miniappAgree.disabled   = !miniappUnlockedByScroll;

  if(cremationUnlockedByScroll) cremationHint.textContent = "※スクロール済みです。チェックできます。";
  if(privacyUnlockedByScroll)   privacyHint.textContent   = "※スクロール済みです。チェックできます。";
  if(miniappUnlockedByScroll)   miniappHint.textContent   = "※スクロール済みです。チェックできます。";

  cremationScroll.addEventListener('scroll', () => {
    if (cremationUnlockedByScroll) return;
    tryUnlock(cremationScroll, allAgree.checked, (v)=>{ cremationUnlockedByScroll=v; }, cremationAgree, cremationHint);
  });

  privacyScroll.addEventListener('scroll', () => {
    if (privacyUnlockedByScroll) return;
    tryUnlock(privacyScroll, allAgree.checked, (v)=>{ privacyUnlockedByScroll=v; }, privacyAgree, privacyHint);
  });

  miniappScroll.addEventListener('scroll', () => {
    if (miniappUnlockedByScroll) return;
    tryUnlock(miniappScroll, allAgree.checked, (v)=>{ miniappUnlockedByScroll=v; }, miniappAgree, miniappHint);
  });

  allAgree.addEventListener('change', () => applyMasterAgree(allAgree.checked));

  cremationAgree.addEventListener('change', () => {
    if (allAgree.checked && !cremationAgree.checked) { allAgree.checked=false; applyMasterAgree(false); return; }
    syncMasterFromIndividuals(); updateButtonState();
  });
  privacyAgree.addEventListener('change', () => {
    if (allAgree.checked && !privacyAgree.checked) { allAgree.checked=false; applyMasterAgree(false); return; }
    syncMasterFromIndividuals(); updateButtonState();
  });
  miniappAgree.addEventListener('change', () => {
    if (allAgree.checked && !miniappAgree.checked) { allAgree.checked=false; applyMasterAgree(false); return; }
    syncMasterFromIndividuals(); updateButtonState();
  });

  // submit
  submitBtn.addEventListener('click', () => {
    if(roleOther.checked){
      if(!chiefName.value.trim() || !chiefKana.value.trim()){
        alert("喪主の情報（喪主氏名・ふりがな）を入力してください。");
        return;
      }
    }
    syncHidden();
    if(!birthdayHidden.value){
      alert("生年月日（年・月・日）を選択してください。");
      return;
    }

    localStorage.setItem("miniapp_registered", "1");
    localStorage.setItem("miniapp_user_role", roleOther.checked ? "other" : "chief");
    localStorage.setItem("miniapp_birthday", birthdayHidden.value);

    window.location.replace("./index.html");
  });
</script>
</body>
</html>
