<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>火葬申込み</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#111827;
      --disabled:#9ca3af;
      --card:#ffffff;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --radius:16px;
      --font: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Arial, sans-serif;
    }
    * , *::before, *::after{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--font);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    header{
      position:sticky;
      top:0;
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      z-index:10;
    }
    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      max-width:780px;
      margin:0 auto;
    }
    .brand{
      font-weight:800;
      font-size:18px;
      letter-spacing:.02em;
      white-space:nowrap;
    }
    .title{
      font-weight:800;
      font-size:18px;
      text-align:center;
      flex:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    main{
      max-width:780px;
      margin:0 auto;
      padding:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:14px;
    }
    .section-title{
      font-weight:800;
      font-size:18px;
      margin:0 0 10px 0;
    }
    label{
      display:block;
      font-weight:700;
      margin:12px 0 6px 0;
      font-size:16px;
    }
    input[type="text"], input[type="tel"], input[type="email"]{
      display:block;
      width:100%;
      max-width:100%;
      font-size:18px;
      padding:14px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      -webkit-appearance:none;
      appearance:none;
    }
    input[type="text"]:focus, input[type="tel"]:focus, input[type="email"]:focus{
      border-color:#9ca3af;
    }
    .note{
      color:var(--muted);
      font-size:14px;
      margin-top:6px;
    }

    details{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
    }
    details + details{ margin-top:10px; }
    summary{
      cursor:pointer;
      font-weight:800;
      font-size:16px;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .summary-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .badge{
      font-size:12px;
      color:#fff;
      background:#ef4444;
      padding:2px 8px;
      border-radius:999px;
      font-weight:800;
      flex:0 0 auto;
    }

    .scrollbox{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      height:180px;
      overflow:auto;
      padding:12px;
      font-size:14px;
      background:#fafafa;
    }
    .scroll-hint{
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
    }
    .agree-row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed var(--border);
    }
    input[type="checkbox"]{
      width:22px;
      height:22px;
      margin-top:2px;
      accent-color:#111827;
    }
    .checkbox-label{
      font-size:16px;
      font-weight:800;
    }
    .checkbox-sub{
      font-size:13px;
      color:var(--muted);
      margin-top:2px;
    }

    .cta{
      display:grid;
      gap:10px;
    }
    button{
      width:100%;
      font-size:18px;
      font-weight:900;
      padding:14px 12px;
      border:none;
      border-radius:14px;
      cursor:pointer;
      background:var(--primary);
      color:#fff;
    }
    button:disabled{
      cursor:not-allowed;
      background:#d1d5db;
      color:#6b7280;
    }
    .link-row{
      display:flex;
      justify-content:center;
      gap:14px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    a{
      color:#111827;
      font-weight:800;
      text-decoration:underline;
    }
    /* ✅ 役割選択：基本は横並び、狭い画面は縦並び */
    .role-grid{
      display:grid;
      grid-template-columns: 1fr 1fr; /* 横並び */
      gap:10px;
      margin-top:8px;
    }
    
    @media (max-width: 520px){
      .role-grid{
        grid-template-columns: 1fr; /* 狭い時は縦 */
      }
    }
    
    .role-card{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:14px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      cursor:pointer;
    }
    
    .role-card input[type="radio"]{
      width:22px;
      height:22px;
      margin-top:2px;
      accent-color:#111827;
      flex:0 0 auto;
    }
    
    .role-text{
      min-width:0;
    }
    
    .role-title{
      font-weight:900;
      font-size:16px;
      line-height:1.2;
    }
    
    .role-sub{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      line-height:1.45;
    }
    
    /* 選択時の強調（:has 非対応でもOK。対応端末だけ効く） */
    .role-card:has(input:checked){
      border-color:#9ca3af;
      box-shadow:0 0 0 3px rgba(17,24,39,.06);
    }
  </style>
</head>

<body>
<header>
  <div class="header-row">
    <div class="brand">喪主の力</div>
    <div class="title">火葬申込み</div>
    <div style="width:72px;"></div>
  </div>
</header>

<main>
  <form id="registerForm" class="card" onsubmit="return false;">
    <h2 class="section-title">火葬申込み</h2>
<!-- ✅ 役割選択（必須 / デフォルト未選択 / 横並び） -->
    <label>利用区分（必須）</label>
    <div class="role-grid" role="radiogroup" aria-label="利用区分">
      <label class="role-card" for="roleChief">
        <input type="radio" name="role" value="chief" id="roleChief" required>
        <div class="role-text">
          <div class="role-title">喪主</div>
          <div class="role-sub">火葬申込み・代表者として手続きを進めます</div>
        </div>
      </label>
    
      <label class="role-card" for="roleCompanion">
        <input type="radio" name="role" value="companion" id="roleCompanion" required>
        <div class="role-text">
          <div class="role-title">同行者</div>
        </div>
      </label>
    </div>

    <label for="name">申込者氏名（必須）</label>
    <input id="name" name="name" type="text" placeholder="例：山田 太郎" autocomplete="name" required />

    <label for="tel">電話番号（必須）</label>
    <input id="tel" name="tel" type="tel" placeholder="例：09012345678" autocomplete="tel" required />

    <label for="address">住所（必須）</label>
    <input id="address" name="address" type="text" placeholder="例：東京都〇〇区…" autocomplete="street-address" required />

    <!-- ✅ 追加：メールアドレス（任意） -->
    <label for="email">メールアドレス（任意）</label>
    <input id="email" name="email" type="email" placeholder="例：example@example.com" autocomplete="email" />

    <p class="note">※入力項目は今後増える可能性があります。</p>
  </form>

  <div class="card">
    <h3 class="section-title">同意事項</h3>

    <!-- master agree -->
    <div class="agree-row" style="border-top:none; padding-top:0;">
      <input id="allAgree" type="checkbox" />
      <div>
        <div class="checkbox-label">すべての規約に同意する</div>
        <div class="checkbox-sub">※このチェックを入れる場合は、スクロールせずに同意できます。</div>
      </div>
    </div>

    <div style="height:10px;"></div>

    <!-- Cremation terms -->
    <details open>
      <summary>
        <div class="summary-row">
          <span>火葬の規約</span>
        </div>
      </summary>

      <div id="cremationScroll" class="scrollbox" aria-label="火葬の規約">
        <p><strong>【火葬の規約】</strong></p>
        <p>本規約は、火葬申込みに関する手続き・利用条件・注意事項を定めるものです。</p>

        <p><strong>1. 申込みについて</strong></p>
        <ul>
          <li>申込内容に不備がある場合、受付ができない場合があります。</li>
          <li>入力内容は、正確にご記入ください。</li>
        </ul>

        <p><strong>2. 変更・取消について</strong></p>
        <ul>
          <li>変更・取消の可否や期限は、斎場・運用ルールに従います。</li>
        </ul>

        <p><strong>3. 個人情報の取扱い（火葬の規約に含む）</strong></p>
        <ul>
          <li>取得する情報：氏名、電話番号、住所、メールアドレス（任意）、その他申込みに必要な情報</li>
          <li>利用目的：申込み受付、本人確認、連絡、運営上必要な案内、問合せ対応 等</li>
          <li>第三者提供：法令に基づく場合等を除き、本人同意なく提供しません。</li>
          <li>安全管理：不正アクセス等の防止に努めます。</li>
        </ul>

        <p><strong>4. 免責</strong></p>
        <ul>
          <li>通信障害等により申込みが正常に行えない場合があります。</li>
        </ul>

        <p class="note">（ここは正式な規約文に差し替えてください）</p>
      </div>

      <div id="cremationHint" class="scroll-hint">※最後までスクロールするとチェックできます。</div>

      <div class="agree-row">
        <input id="cremationAgree" type="checkbox" disabled />
        <div>
          <div class="checkbox-label">「火葬の規約」に同意します</div>
          <div class="checkbox-sub">※個人情報の取扱いも本規約に含まれます。</div>
        </div>
      </div>
    </details>

    <!-- Miniapp terms -->
    <details>
      <summary>
        <div class="summary-row">
          <span>葬儀ミニアプリ利用の規約</span>
        </div>
      </summary>

      <div id="miniappScroll" class="scrollbox" aria-label="葬儀ミニアプリ利用の規約（アプリ機能）">
        <p><strong>【葬儀ミニアプリ利用の規約（アプリ機能）】</strong></p>

        <p><strong>■ご利用メリット</strong></p>
        <ul>
          <li><strong>無料Wi-Fi接続</strong>：斎場内で通信環境が不安な場合でも使いやすくなります。</li>
          <li><strong>モバイルオーダー</strong>：売店や対象サービスをスマホからスムーズに注文できます。</li>
        </ul>

        <p><strong>1. 提供機能</strong></p>
        <ul>
          <li>館内案内、通知、（対象の場合）モバイルオーダー等の機能を提供します。</li>
        </ul>

        <p><strong>2. 利用上の注意</strong></p>
        <ul>
          <li>端末・通信環境により一部機能が利用できない場合があります。</li>
          <li>混雑時など、機能の提供を一時停止する場合があります。</li>
        </ul>

        <p><strong>3. 禁止事項</strong></p>
        <ul>
          <li>不正利用、第三者になりすます行為、サービスの妨害行為 等</li>
        </ul>

        <p><strong>4. 免責</strong></p>
        <ul>
          <li>システム障害等により機能が利用できない場合があります。</li>
        </ul>

        <p class="note">（ここも正式な規約文に差し替えてください）</p>
      </div>

      <div id="miniappHint" class="scroll-hint">※最後までスクロールするとチェックできます。</div>

      <div class="agree-row">
        <input id="miniappAgree" type="checkbox" disabled />
        <div>
          <div class="checkbox-label">「葬儀ミニアプリ利用の規約（アプリ機能）」に同意します</div>
          <div class="checkbox-sub">※無料Wi-Fi接続／モバイルオーダー等の機能を利用できます。</div>
        </div>
      </div>
    </details>
  </div>

  <div class="card cta">
    <button id="submitBtn" type="button" disabled>登録</button>
    <p class="note" style="margin:0;">※「登録」は、2つの規約への同意がそろった時点で押せます。</p>
  </div>
</main>

<script>
  // elements
  const allAgree = document.getElementById('allAgree');
  const cremationScroll = document.getElementById('cremationScroll');
  const miniappScroll = document.getElementById('miniappScroll');

  const cremationAgree = document.getElementById('cremationAgree');
  const miniappAgree = document.getElementById('miniappAgree');

  const cremationHint = document.getElementById('cremationHint');
  const miniappHint = document.getElementById('miniappHint');

  const submitBtn = document.getElementById('submitBtn');

  // state
  let cremationUnlockedByScroll = false;
  let miniappUnlockedByScroll = false;

  function nearBottom(el) {
    return el.scrollTop + el.clientHeight >= el.scrollHeight - 5;
  }

  function updateButtonState() {
    const ok = cremationAgree.checked && miniappAgree.checked;
    submitBtn.disabled = !ok;
  }

  function syncMasterFromIndividuals() {
    const both = cremationAgree.checked && miniappAgree.checked;
    allAgree.checked = both;
  }

  function applyMasterAgree(isOn) {
    if (isOn) {
      cremationAgree.disabled = false;
      miniappAgree.disabled = false;

      cremationAgree.checked = true;
      miniappAgree.checked = true;

      cremationHint.textContent = "※「すべて同意」を選択中のため、スクロール不要です。";
      miniappHint.textContent = "※「すべて同意」を選択中のため、スクロール不要です。";
    } else {
      cremationAgree.checked = false;
      miniappAgree.checked = false;

      cremationAgree.disabled = !cremationUnlockedByScroll;
      miniappAgree.disabled = !miniappUnlockedByScroll;

      cremationHint.textContent = cremationUnlockedByScroll
        ? "※スクロール済みです。チェックできます。"
        : "※最後までスクロールするとチェックできます。";

      miniappHint.textContent = miniappUnlockedByScroll
        ? "※スクロール済みです。チェックできます。"
        : "※最後までスクロールするとチェックできます。";
    }

    updateButtonState();
  }

  // scroll unlock: cremation
  cremationScroll.addEventListener('scroll', () => {
    if (cremationUnlockedByScroll) return;
    if (!allAgree.checked && nearBottom(cremationScroll)) {
      cremationUnlockedByScroll = true;
      cremationAgree.disabled = false;
      cremationHint.textContent = "※スクロール済みです。チェックできます。";
    }
  });

  // scroll unlock: miniapp
  miniappScroll.addEventListener('scroll', () => {
    if (miniappUnlockedByScroll) return;
    if (!allAgree.checked && nearBottom(miniappScroll)) {
      miniappUnlockedByScroll = true;
      miniappAgree.disabled = false;
      miniappHint.textContent = "※スクロール済みです。チェックできます。";
    }
  });

  // master agree
  allAgree.addEventListener('change', () => {
    applyMasterAgree(allAgree.checked);
  });

  // individual agrees
  cremationAgree.addEventListener('change', () => {
    if (allAgree.checked && !cremationAgree.checked) {
      allAgree.checked = false;
      applyMasterAgree(false);
      return;
    }
    syncMasterFromIndividuals();
    updateButtonState();
  });

  miniappAgree.addEventListener('change', () => {
    if (allAgree.checked && !miniappAgree.checked) {
      allAgree.checked = false;
      applyMasterAgree(false);
      return;
    }
    syncMasterFromIndividuals();
    updateButtonState();
  });

  // submit (mock) -> ホームへ
  submitBtn.addEventListener('click', () => {
 const role = document.querySelector('input[name="role"]:checked')?.value;

  if(!role){
    alert("利用区分（喪主／同行者）を選択してください。");
    return;
  }

  // 本来はAPI送信→成功後に登録済み保存
  localStorage.setItem("miniapp_registered", "1");
  localStorage.setItem("miniapp_user_role", role); // chief / companion

  window.location.replace("./index.html");
  });
</script>
</body>
</html>
