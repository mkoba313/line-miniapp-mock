<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>オーダー（購入）</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --soft:#f9fafb;

      --radius:16px;
      --shadow: 0 10px 28px rgba(17,24,39,.08);

      --primary:#111827;
      --blue:#2563eb;
      --danger:#dc2626;

      --tap:56px;
      --max:520px;

      --title:22px;
      --label:18px;
      --sub:14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
      padding-bottom: 92px; /* bottom bar space */
    }

    /* ===== Header ===== */
    .header{
      height:64px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      border-bottom:1px solid var(--line);
      padding:0 12px;
      background:#fff;
      position:sticky;
      top:0;
      z-index:50;
      gap:8px;
    }
    .header-title{
      grid-column:2;
      font-size: var(--title);
      font-weight: 900;
      text-align:center;
      letter-spacing:.02em;
    }
    .header-right{
      grid-column:3;
      justify-self:end;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .iconBtn{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .iconBtn:active{ background:#f3f4f6; }
    .iconBtn svg{ width:22px;height:22px; }

    .header-home{
      font-size:18px;
      font-weight:900;
      text-decoration:none;
      color: var(--blue);
      white-space:nowrap;
    }

    /* role switch */
    .role-switch{ display:flex; gap:4px; }
    .role-switch button{
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .role-switch button.active{
      background: var(--primary);
      color:#fff;
      border-color: var(--primary);
    }

    .wrap{
      max-width: var(--max);
      margin:0 auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background:#fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
    }
    .card-hd .h{
      font-size:16px;
      font-weight:900;
      color:#374151;
    }
    .pill{
      font-size:12px;
      font-weight:800;
      color: var(--muted);
      border:1px solid var(--line);
      background:#fff;
      padding:8px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* disabled banner */
    .banner{
      border:1px solid #fde68a;
      background:#fffbeb;
      color:#92400e;
      border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      line-height:1.4;
    }

    /* ===== Settlement QR ===== */
    .qrBig{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .qrBox{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .qrWrap{
      display:flex;
      justify-content:center;
      padding:6px 0 2px;
    }
    .qr{
      width:270px;
      height:270px;
      border-radius:18px;
      border:1px solid var(--line);
      background:#fff;
      display:grid;
      place-items:center;
      box-shadow: 0 10px 28px rgba(17,24,39,.06);
    }
    .qr svg{ width:248px; height:248px; display:block; }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:900;
    }
    .row .label{ font-size:14px; color:var(--muted); }
    .row .value{ font-size:20px; }

    .toggleLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background: var(--soft);
      font-weight:900;
    }
    .toggleLine input{ width:20px; height:20px; }

    /* ===== Popular sticky ===== */
    .stickyPopular{
      position: sticky;
      top: 64px; /* header height */
      z-index:40;
    }

    /* ===== Search ===== */
    .search{
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search input{
      flex:1;
      height:52px;
      border-radius:14px;
      border:1px solid var(--line);
      padding:0 14px;
      font-size:16px;
      font-weight:800;
      outline:none;
      background:#fff;
    }

    /* Product list */
    .list{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
      opacity:.75; /* all disabled */
    }
    .left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .name{
      font-size: var(--label);
      font-weight: 900;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: var(--sub);
      color: var(--muted);
      font-weight:800;
    }
    .price{
      font-size: 16px;
      font-weight: 900;
      color:#111827;
    }
    .right{ display:flex; align-items:center; gap:10px; flex: 0 0 auto; }

    .qty{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      height:48px;
      background:#fff;
      opacity:.7;
    }
    .qty button{
      width:48px;
      height:48px;
      border:0;
      background:#fff;
      font-size:22px;
      font-weight:900;
      cursor:not-allowed;
    }
    .qty .n{
      width:48px;
      text-align:center;
      font-size:18px;
      font-weight:900;
      color:#374151;
    }

    .smallNote{
      padding:10px 16px 14px;
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      line-height:1.4;
      text-align:center;
    }

    /* Bottom bar (host only) */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      background:#fff;
      border-top:1px solid var(--line);
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      z-index:60;
    }
    .bottomInner{
      max-width: var(--max);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 14px;
      box-shadow: var(--shadow);
    }
    .bottomInner .t{ font-weight:900; color:#374151; }
    .bottomInner .v{ font-weight:900; font-size:20px; }
    .bottomInner .btnMini{
      height:44px;
      padding:0 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#f3f4f6;
      font-weight:900;
      cursor:not-allowed;
      color:#6b7280;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <header class="header">
    <div></div>
    <div class="header-title">オーダー</div>

    <div class="header-right">
      <button class="iconBtn" type="button" id="cartGo" aria-label="カートへ">
        <!-- cart icon -->
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6h15l-2 9H8L6 6Z" stroke="#111827" stroke-width="2" stroke-linejoin="round"/>
          <path d="M6 6 5 3H2" stroke="#111827" stroke-width="2" stroke-linecap="round"/>
          <circle cx="9" cy="20" r="1.6" fill="#111827"/>
          <circle cx="18" cy="20" r="1.6" fill="#111827"/>
        </svg>
      </button>

      <div class="role-switch" aria-label="表示切替">
        <button id="btnHost" type="button">喪主</button>
        <button id="btnCompanion" type="button">同行者</button>
      </div>
      <a class="header-home" href="./index.html">ホーム</a>
    </div>
  </header>

  <div class="wrap">
    <div class="banner">現在、オーダー機能は停止中です（表示のみ）。</div>

    <!-- 精算QR（喪主 + 精算確定 ON のときだけ表示） -->
    <section class="card" id="qrSection" style="display:none;">
      <div class="card-hd">
        <div class="h">精算QRコード</div>
        <div class="pill">喪主のみ</div>
      </div>
      <div class="qrBig">
        <div class="qrBox">
          <div class="row">
            <div class="label">精算金額</div>
            <div class="value" id="payTotal">¥0</div>
          </div>
          <div class="qrWrap">
            <div class="qr" aria-label="精算QRコード">
              <div id="qrHost"></div>
            </div>
          </div>
        </div>

        <!-- デモ用（管理画面で確定した想定の切替） -->
        <label class="toggleLine">
          <span>（デモ）精算確定</span>
          <input id="settledToggle" type="checkbox" />
        </label>

        <div class="smallNote">※管理画面で精算金額が確定したら表示される想定です</div>
      </div>
    </section>

    <!-- 人気商品（固定表示） -->
    <section class="card stickyPopular">
      <div class="card-hd">
        <div class="h">人気商品</div>
        <div class="pill">固定</div>
      </div>
      <div class="list" id="popularList"></div>
    </section>

    <!-- 商品一覧 + 検索 -->
    <section class="card">
      <div class="card-hd">
        <div class="h">商品一覧</div>
        <div class="pill">売店</div>
      </div>

      <div class="search">
        <input id="searchInput" type="search" placeholder="商品名で検索" autocomplete="off" />
      </div>

      <div class="list" id="productList"></div>
      <div class="smallNote">※オーダー停止中のため数量変更はできません</div>
    </section>
  </div>

  <!-- bottom (host only) -->
  <div class="bottomBar" id="bottomBar" style="display:none;">
    <div class="bottomInner">
      <div>
        <div class="t">精算金額 合計</div>
        <div class="v" id="bottomTotal">¥0</div>
      </div>
      <button class="btnMini" type="button" disabled>精算（停止中）</button>
    </div>
  </div>

  <script>
    // ===== demo products =====
    const POPULAR_FIXED = [
      { id:"p_beer", name:"瓶ビール", price:600 },
      { id:"p_tea",  name:"お茶（ペットボトル）", price:160 },
      { id:"p_wet",  name:"おしぼり", price:80 },
    ];

    const PRODUCTS = [
      ...POPULAR_FIXED,
      { id:"s_water", name:"水（ペットボトル）", price:120 },
      { id:"s_candy", name:"のど飴", price:150 },
      { id:"s_towel", name:"ハンカチ", price:300 },
      { id:"s_coffee", name:"コーヒー（缶）", price:140 },
      { id:"s_choco", name:"チョコレート", price:220 },
    ];

    // ===== localStorage keys =====
    const LS_CART = "miniapp_cart";
    const LS_ROLE = "miniapp_role"; // "host" | "companion"
    const LS_SETTLED = "miniapp_settled"; // "1" | "0"

    if(!localStorage.getItem(LS_ROLE)) localStorage.setItem(LS_ROLE, "host");
    if(localStorage.getItem(LS_SETTLED) == null) localStorage.setItem(LS_SETTLED, "0");

    // ===== elements =====
    const btnHost = document.getElementById("btnHost");
    const btnCompanion = document.getElementById("btnCompanion");
    const cartGo = document.getElementById("cartGo");

    const popularListEl = document.getElementById("popularList");
    const productListEl = document.getElementById("productList");
    const searchInput = document.getElementById("searchInput");

    const qrSection = document.getElementById("qrSection");
    const payTotalEl = document.getElementById("payTotal");
    const qrHost = document.getElementById("qrHost");
    const settledToggle = document.getElementById("settledToggle");

    const bottomBar = document.getElementById("bottomBar");
    const bottomTotal = document.getElementById("bottomTotal");

    // ===== utils =====
    function yen(n){ return "¥" + Number(n||0).toLocaleString("ja-JP"); }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function loadCart(){
      try{
        const raw = localStorage.getItem(LS_CART);
        if(!raw) return {};
        const obj = JSON.parse(raw);
        return (obj && typeof obj === "object") ? obj : {};
      }catch{
        return {};
      }
    }
    function cartTotal(){
      const cart = loadCart();
      let sum=0;
      for(const [id, qty] of Object.entries(cart)){
        const p = PRODUCTS.find(x=>x.id===id);
        if(p) sum += p.price * Number(qty||0);
      }
      return sum;
    }

    // ===== QR mock =====
    function hash(str){
      let h = 2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0);
    }
    function renderFakeQR(payload){
      const seed = hash(payload);
      const size = 21;
      const cell = 248 / size;
      let cells = "";

      function rect(x,y){
        return `<rect x="${x*cell}" y="${y*cell}" width="${cell}" height="${cell}" fill="#111827"/>`;
      }
      function on(x,y){
        const v = (seed + x*31 + y*17 + (x*y)*7) % 11;
        return v < 5;
      }
      function finder(x0,y0){
        const s=7;
        for(let y=0;y<s;y++){
          for(let x=0;x<s;x++){
            const border = x===0||y===0||x===s-1||y===s-1;
            const inner  = x>=2&&x<=4&&y>=2&&y<=4;
            if(border || inner) cells += rect(x0+x, y0+y);
          }
        }
      }

      for(let y=0;y<size;y++){
        for(let x=0;x<size;x++){
          const inFinder =
            (x<7 && y<7) || (x>=size-7 && y<7) || (x<7 && y>=size-7);
          if(inFinder) continue;
          if(on(x,y)) cells += rect(x,y);
        }
      }
      finder(0,0); finder(size-7,0); finder(0,size-7);

      return `
        <svg viewBox="0 0 248 248" width="248" height="248" role="img" aria-label="QR">
          <rect x="0" y="0" width="248" height="248" fill="#fff"/>
          ${cells}
        </svg>
      `;
    }

    // ===== role =====
    function getRole(){ return localStorage.getItem(LS_ROLE) || "host"; }
    function setRole(role){
      localStorage.setItem(LS_ROLE, role);
      renderRole();
    }
    function isSettled(){ return (localStorage.getItem(LS_SETTLED) || "0") === "1"; }
    function setSettled(v){ localStorage.setItem(LS_SETTLED, v ? "1" : "0"); }

    btnHost.addEventListener("click", ()=>setRole("host"));
    btnCompanion.addEventListener("click", ()=>setRole("companion"));
    cartGo.addEventListener("click", ()=>{ location.href = "./cart.html"; });

    settledToggle.addEventListener("change", ()=>{
      setSettled(settledToggle.checked);
      renderSettlement();
    });

    // ===== render =====
    function renderRole(){
      const role = getRole();
      const host = role === "host";
      btnHost.classList.toggle("active", host);
      btnCompanion.classList.toggle("active", !host);

      // bottom bar (host only)
      bottomBar.style.display = host ? "" : "none";

      // settled toggle sync
      settledToggle.checked = isSettled();

      renderSettlement();
      renderBottom();
    }

    function renderSettlement(){
      const host = getRole() === "host";
      const settled = isSettled();
      const total = cartTotal();

      // QR is shown only when host AND settled
      qrSection.style.display = (host && settled) ? "" : "none";

      // totals
      payTotalEl.textContent = yen(total);

      if(host && settled){
        const payId = `PAY|TOTAL=${total}|DATE=${new Date().toISOString().slice(0,10)}`;
        qrHost.innerHTML = renderFakeQR(payId);
      }else{
        qrHost.innerHTML = "";
      }
    }

    function renderBottom(){
      bottomTotal.textContent = yen(cartTotal());
    }

    function renderProductItem(p){
      // all disabled: qty fixed display only (reads from cart)
      const cart = loadCart();
      const q = Number(cart[p.id] || 0);

      return `
        <div class="item">
          <div class="left">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="meta"><span class="price">${yen(p.price)}</span></div>
          </div>
          <div class="right">
            <div class="qty" aria-label="${escapeHtml(p.name)} 数量（停止中）">
              <button type="button" disabled aria-label="減らす">−</button>
              <div class="n">${q}</div>
              <button type="button" disabled aria-label="増やす">＋</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderPopular(){
      popularListEl.innerHTML = POPULAR_FIXED.map(renderProductItem).join("");
    }

    function renderProducts(){
      const kw = (searchInput.value || "").trim().toLowerCase();
      const list = PRODUCTS.filter(p=>{
        if(!kw) return !POPULAR_FIXED.some(x=>x.id===p.id); // popularは別枠
        return p.name.toLowerCase().includes(kw) && !POPULAR_FIXED.some(x=>x.id===p.id);
      });
      productListEl.innerHTML = list.map(renderProductItem).join("");

      // 検索時、人気商品は表示したまま（固定）
    }

    searchInput.addEventListener("input", renderProducts);

    function render(){
      renderRole();
      renderPopular();
      renderProducts();
      renderBottom();
    }

    render();
  </script>
</body>
</html>
