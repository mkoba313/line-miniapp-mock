<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>オーダー（購入）</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --soft:#f9fafb;

      --radius:16px;
      --shadow: 0 10px 28px rgba(17,24,39,.08);

      --primary:#111827;
      --blue:#2563eb;
      --ok:#16a34a;
      --danger:#dc2626;

      --tap:56px;
      --max:520px;

      --title:22px;
      --label:18px;
      --sub:14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
      padding-bottom: 96px; /* bottom bar space */
    }

    /* ===== Header ===== */
    .header{
      height:64px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      border-bottom:1px solid var(--line);
      padding:0 12px;
      background:#fff;
      position:sticky;
      top:0;
      z-index:60;
      gap:8px;
    }
    .header-title{
      grid-column:2;
      font-size: var(--title);
      font-weight: 900;
      text-align:center;
      letter-spacing:.02em;
    }
    .header-right{
      grid-column:3;
      justify-self:end;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .header-home{
      font-size:18px;
      font-weight:900;
      text-decoration:none;
      color: var(--blue);
      white-space:nowrap;
    }

    /* Cart icon + badge */
    .iconBtn{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
      position:relative;
    }
    .iconBtn:active{ background:#f3f4f6; }
    .iconBtn svg{ width:22px;height:22px; }
    .badge{
      position:absolute;
      top:-6px; right:-6px;
      min-width:22px;
      height:22px;
      padding:0 6px;
      border-radius:999px;
      background:#dc2626;
      color:#fff;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:900;
      border:2px solid #fff;
    }

    /* Role switch */
    .role-switch{ display:flex; gap:4px; }
    .role-switch button{
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .role-switch button.active{
      background: var(--primary);
      color:#fff;
      border-color: var(--primary);
    }

    /* Header toggles (roleの横) */
    .toggleGroup{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      font-size:12px;
      font-weight:900;
      color:#374151;
      white-space:nowrap;
    }
    .toggle input{ width:18px;height:18px; }

    /* Stop banner */
    .stopBanner{
      position:sticky;
      top:64px;
      z-index:55;
      border-bottom:1px solid #fecaca;
      background:#fff1f2;
      color:#991b1b;
      font-weight:900;
      padding:10px 12px;
      display:none;
    }
    .stopBanner .inner{
      max-width: var(--max);
      margin:0 auto;
      text-align:center;
    }

    .wrap{
      max-width: var(--max);
      margin:0 auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background:#fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
    }
    .card-hd .h{
      font-size:16px;
      font-weight:900;
      color:#374151;
    }
    .pill{
      font-size:12px;
      font-weight:800;
      color: var(--muted);
      border:1px solid var(--line);
      background:#fff;
      padding:8px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* Settlement big QR */
    .pay{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    .payBox{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .payRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:900;
    }
    .payRow .label{ font-size:14px; color: var(--muted); font-weight:900; }
    .payRow .value{ font-size:22px; color: var(--text); font-weight:900; }
    .qrWrap{ display:flex; justify-content:center; padding:8px 0 2px; }
    .qr{
      width:270px;
      height:270px;
      border-radius:18px;
      border:1px solid var(--line);
      background:#fff;
      display:grid;
      place-items:center;
      box-shadow: 0 10px 28px rgba(17,24,39,.06);
    }
    .qr svg{ width:248px; height:248px; display:block; }
    .smallNote{
      padding:10px 16px 14px;
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      line-height:1.4;
      text-align:center;
    }

    /* Popular sticky */
    .stickyPopular{
      position:sticky;
      top: calc(64px + 42px); /* header + stop banner(rough) */
      z-index:40;
    }

    /* Search */
    .search{ padding:12px; display:flex; gap:10px; align-items:center; }
    .search input{
      flex:1;
      height:54px;
      border-radius:14px;
      border:1px solid var(--line);
      padding:0 14px;
      font-size:16px;
      font-weight:800;
      outline:none;
      background:#fff;
    }

    /* Product list rows */
    .list{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
    }
    .left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .name{
      font-size: var(--label);
      font-weight: 900;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: var(--sub);
      color: var(--muted);
      font-weight:800;
    }
    .price{
      font-size: 16px;
      font-weight: 900;
      color:#111827;
    }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
    }

    .qtyBox{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .qty{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      height:48px;
      background:#fff;
    }
    .qty button{
      width:48px;
      height:48px;
      border:0;
      background:#fff;
      font-size:22px;
      font-weight:900;
      cursor:pointer;
    }
    .qty button:active{ background:#f3f4f6; }
    .qty .n{
      width:48px;
      text-align:center;
      font-size:18px;
      font-weight:900;
    }

    .addBtn{
      height:48px;
      padding:0 14px;
      border-radius:14px;
      border:0;
      background: var(--ok);
      color:#fff;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      box-shadow: var(--shadow);
      white-space:nowrap;
    }
    .addBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* Bottom bar (host only) */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      background:#fff;
      border-top:1px solid var(--line);
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      z-index:70;
      display:none;
    }
    .bottomInner{
      max-width: var(--max);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 14px;
      box-shadow: var(--shadow);
    }
    .bottomInner .t{ font-weight:900; color:#374151; }
    .bottomInner .v{ font-weight:900; font-size:22px; }

    /* STOP state */
    .stopped .item{ opacity:.65; }
    .stopped .qty{ pointer-events:none; opacity:.55; }
    .stopped .addBtn{ pointer-events:none; }
    .stopped .search input{ pointer-events:none; opacity:.6; background:#f9fafb; }
  </style>
</head>

<body>
  <header class="header">
    <div></div>
    <div class="header-title">オーダー</div>

    <div class="header-right">
      <!-- cart -->
      <button class="iconBtn" id="cartBtn" type="button" aria-label="カートへ">
        <span class="badge" id="cartBadge">0</span>
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6h15l-2 9H8L6 6Z" stroke="#111827" stroke-width="2" stroke-linejoin="round"/>
          <path d="M6 6 5 3H2" stroke="#111827" stroke-width="2" stroke-linecap="round"/>
          <circle cx="9" cy="20" r="1.6" fill="#111827"/>
          <circle cx="18" cy="20" r="1.6" fill="#111827"/>
        </svg>
      </button>

      <!-- role + flags (横並び) -->
      <div class="toggleGroup">
        <div class="role-switch" aria-label="表示切替">
          <button id="btnHost" type="button">喪主</button>
          <button id="btnCompanion" type="button">同行者</button>
        </div>

        <!-- ★ここが要望：切替の横に停止フラグ -->
        <label class="toggle" title="オーダー停止">
          <span>停止</span>
          <input id="stopToggle" type="checkbox" />
        </label>

        <label class="toggle" id="settleToggleWrap" title="精算確定（喪主のみ）">
          <span>精算確定</span>
          <input id="settleToggle" type="checkbox" />
        </label>
      </div>

      <a class="header-home" href="./index.html">ホーム</a>
    </div>
  </header>

  <div class="stopBanner" id="stopBanner">
    <div class="inner">オーダー停止中です（現在ご注文いただけません）</div>
  </div>

  <div class="wrap" id="appRoot">
    <!-- 精算QR（喪主 + 精算確定 ON のときだけ表示） -->
    <section class="card" id="qrSection" style="display:none;">
      <div class="card-hd">
        <div class="h">精算QRコード</div>
        <div class="pill">喪主のみ</div>
      </div>
      <div class="pay">
        <div class="payBox">
          <div class="payRow">
            <div class="label">精算金額</div>
            <div class="value" id="payTotal">¥0</div>
          </div>
          <div class="qrWrap">
            <div class="qr" aria-label="精算QRコード">
              <div id="qrHost"></div>
            </div>
          </div>
        </div>
        <div class="smallNote">※管理画面で精算確定したら表示される想定です</div>
      </div>
    </section>

    <!-- 人気商品（固定） -->
    <section class="card stickyPopular">
      <div class="card-hd">
        <div class="h">人気商品</div>
        <div class="pill">固定</div>
      </div>
      <div class="list" id="popularList"></div>
    </section>

    <!-- 商品一覧（検索） -->
    <section class="card">
      <div class="card-hd">
        <div class="h">商品一覧</div>
        <div class="pill">売店</div>
      </div>

      <div class="search">
        <input id="searchInput" type="search" placeholder="商品名で検索" autocomplete="off" />
      </div>

      <div class="list" id="productList"></div>
      <div class="smallNote">※数量を入れて「カートに入れる」を押してください</div>
    </section>
  </div>

  <!-- 喪主のみ：画面下部に精算金額合計（表示のみ） -->
  <div class="bottomBar" id="bottomBar">
    <div class="bottomInner">
      <div>
        <div class="t">精算金額 合計</div>
        <div class="v" id="bottomTotal">¥0</div>
      </div>
      <div class="pill" id="bottomNote">表示のみ</div>
    </div>
  </div>

  <script>
    // ===== Products =====
    const POPULAR_FIXED = [
      { id:"p_beer", name:"瓶ビール", price:600 },
      { id:"p_tea",  name:"お茶（ペットボトル）", price:160 },
      { id:"p_wet",  name:"おしぼり", price:80 },
    ];

    const PRODUCTS = [
      ...POPULAR_FIXED,
      { id:"s_water", name:"水（ペットボトル）", price:120 },
      { id:"s_candy", name:"のど飴", price:150 },
      { id:"s_towel", name:"ハンカチ", price:300 },
      { id:"s_coffee", name:"コーヒー（缶）", price:140 },
      { id:"s_choco", name:"チョコレート", price:220 },
    ];

    // ===== Storage Keys =====
    const LS_CART = "miniapp_cart";               // { [id]: qty }
    const LS_ROLE = "miniapp_role";               // "host" | "companion"
    const LS_ORDER_STOP = "miniapp_order_stop";   // "1" stop | "0" run
    const LS_SETTLED = "miniapp_settled";         // "1" settled | "0" not

    // defaults
    if(!localStorage.getItem(LS_ROLE)) localStorage.setItem(LS_ROLE, "host");
    if(localStorage.getItem(LS_ORDER_STOP) == null) localStorage.setItem(LS_ORDER_STOP, "1"); // 初期：停止
    if(localStorage.getItem(LS_SETTLED) == null) localStorage.setItem(LS_SETTLED, "0");

    // ===== Elements =====
    const appRoot = document.getElementById("appRoot");
    const stopBanner = document.getElementById("stopBanner");

    const cartBtn = document.getElementById("cartBtn");
    const cartBadge = document.getElementById("cartBadge");

    const btnHost = document.getElementById("btnHost");
    const btnCompanion = document.getElementById("btnCompanion");

    const stopToggle = document.getElementById("stopToggle");
    const settleToggle = document.getElementById("settleToggle");
    const settleToggleWrap = document.getElementById("settleToggleWrap");

    const qrSection = document.getElementById("qrSection");
    const payTotalEl = document.getElementById("payTotal");
    const qrHost = document.getElementById("qrHost");

    const popularListEl = document.getElementById("popularList");
    const productListEl = document.getElementById("productList");
    const searchInput = document.getElementById("searchInput");

    const bottomBar = document.getElementById("bottomBar");
    const bottomTotal = document.getElementById("bottomTotal");

    // ===== State =====
    let cart = loadCart();
    const pendingQty = {}; // 入力中数量（カートに入れる前）

    // ===== Utils =====
    function yen(n){ return "¥" + Number(n||0).toLocaleString("ja-JP"); }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function loadCart(){
      try{
        const raw = localStorage.getItem(LS_CART);
        if(!raw) return {};
        const obj = JSON.parse(raw);
        return (obj && typeof obj === "object") ? obj : {};
      }catch{
        return {};
      }
    }
    function persistCart(){
      localStorage.setItem(LS_CART, JSON.stringify(cart));
    }

    function cartCount(){
      return Object.values(cart).reduce((a,b)=>a+Number(b||0),0);
    }
    function cartTotal(){
      let sum=0;
      for(const [id, qty] of Object.entries(cart)){
        const p = PRODUCTS.find(x=>x.id===id);
        if(p) sum += p.price * Number(qty||0);
      }
      return sum;
    }

    function getRole(){ return localStorage.getItem(LS_ROLE) || "host"; }
    function setRole(role){
      localStorage.setItem(LS_ROLE, role);
      renderAll();
    }

    function isStopped(){ return (localStorage.getItem(LS_ORDER_STOP) || "1") === "1"; }
    function setStopped(v){
      localStorage.setItem(LS_ORDER_STOP, v ? "1" : "0");
      renderAll();
    }

    function isSettled(){ return (localStorage.getItem(LS_SETTLED) || "0") === "1"; }
    function setSettled(v){
      localStorage.setItem(LS_SETTLED, v ? "1" : "0");
      renderAll();
    }

    // ===== Fake QR =====
    function hash(str){
      let h = 2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0);
    }
    function renderFakeQR(payload){
      const seed = hash(payload);
      const size = 21;
      const cell = 248 / size;
      let cells = "";

      function rect(x,y){
        return `<rect x="${x*cell}" y="${y*cell}" width="${cell}" height="${cell}" fill="#111827"/>`;
      }
      function on(x,y){
        const v = (seed + x*31 + y*17 + (x*y)*7) % 11;
        return v < 5;
      }
      function finder(x0,y0){
        const s=7;
        for(let y=0;y<s;y++){
          for(let x=0;x<s;x++){
            const border = x===0||y===0||x===s-1||y===s-1;
            const inner  = x>=2&&x<=4&&y>=2&&y<=4;
            if(border || inner) cells += rect(x0+x, y0+y);
          }
        }
      }

      for(let y=0;y<size;y++){
        for(let x=0;x<size;x++){
          const inFinder =
            (x<7 && y<7) || (x>=size-7 && y<7) || (x<7 && y>=size-7);
          if(inFinder) continue;
          if(on(x,y)) cells += rect(x,y);
        }
      }
      finder(0,0); finder(size-7,0); finder(0,size-7);

      return `
        <svg viewBox="0 0 248 248" width="248" height="248" role="img" aria-label="QR">
          <rect x="0" y="0" width="248" height="248" fill="#fff"/>
          ${cells}
        </svg>
      `;
    }

    // ===== Actions =====
    cartBtn.addEventListener("click", ()=>{ location.href = "./cart.html"; });

    btnHost.addEventListener("click", ()=>setRole("host"));
    btnCompanion.addEventListener("click", ()=>setRole("companion"));

    stopToggle.addEventListener("change", ()=> setStopped(stopToggle.checked));
    settleToggle.addEventListener("change", ()=> setSettled(settleToggle.checked));

    function addToCart(id){
      if(isStopped()) return;

      const qty = Number(pendingQty[id] || 0);
      if(qty <= 0) return;

      cart[id] = Number(cart[id] || 0) + qty;
      persistCart();

      // 入力数量リセット（見た目も戻す）
      pendingQty[id] = 0;
      renderAll();
    }

    function changePending(id, delta){
      if(isStopped()) return;
      const cur = Number(pendingQty[id] || 0);
      const next = Math.max(0, cur + delta);
      pendingQty[id] = next;
      renderProducts(); // 部分更新でOK
    }

    // ===== Render =====
    function renderHeader(){
      const role = getRole();
      const host = role === "host";

      btnHost.classList.toggle("active", host);
      btnCompanion.classList.toggle("active", !host);

      // stop toggle
      stopToggle.checked = isStopped();
      stopBanner.style.display = isStopped() ? "" : "none";
      appRoot.classList.toggle("stopped", isStopped());

      // settle toggle: 喪主のみ有効（同行者ではOFF固定）
      if(host){
        settleToggleWrap.style.opacity = "1";
        settleToggle.disabled = false;
        settleToggle.checked = isSettled();
      }else{
        settleToggleWrap.style.opacity = ".45";
        settleToggle.disabled = true;
        settleToggle.checked = false;
      }

      // cart badge
      const c = cartCount();
      if(c > 0){
        cartBadge.style.display = "inline-flex";
        cartBadge.textContent = String(c);
      }else{
        cartBadge.style.display = "none";
      }
    }

    function renderSettlement(){
      const role = getRole();
      const host = role === "host";
      const settled = host && isSettled();

      const total = cartTotal();
      payTotalEl.textContent = yen(total);
      bottomTotal.textContent = yen(total);

      // 喪主のみ：下部合計バー表示
      bottomBar.style.display = host ? "" : "none";

      // QR: 喪主 + 精算確定のみ表示
      qrSection.style.display = settled ? "" : "none";
      if(settled){
        const payId = `PAY|TOTAL=${total}|DATE=${new Date().toISOString().slice(0,10)}`;
        qrHost.innerHTML = renderFakeQR(payId);
      }else{
        qrHost.innerHTML = "";
      }
    }

    function productRowHtml(p, isPopular){
      const inputQty = Number(pendingQty[p.id] || 0);
      const disabled = isStopped();

      return `
        <div class="item" data-id="${p.id}">
          <div class="left">
            <div class="name">${escapeHtml(p.name)}${isPopular ? "（人気）" : ""}</div>
            <div class="meta"><span class="price">${yen(p.price)}</span></div>
          </div>

          <div class="right">
            <div class="qtyBox">
              <div class="qty" aria-label="${escapeHtml(p.name)} 数量入力">
                <button type="button" data-act="minus" data-id="${p.id}" ${disabled ? "disabled" : ""} aria-label="減らす">−</button>
                <div class="n" id="n-${p.id}">${inputQty}</div>
                <button type="button" data-act="plus" data-id="${p.id}" ${disabled ? "disabled" : ""} aria-label="増やす">＋</button>
              </div>
              <button class="addBtn" type="button" data-add="${p.id}" ${disabled || inputQty<=0 ? "disabled" : ""}>
                カートに入れる
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function bindRowEvents(scopeEl){
      // plus/minus
      scopeEl.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          changePending(id, act === "plus" ? 1 : -1);
        });
      });

      // add to cart
      scopeEl.querySelectorAll("button[data-add]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-add");
          addToCart(id);
        });
      });
    }

    function renderPopular(){
      popularListEl.innerHTML = POPULAR_FIXED.map(p => productRowHtml(p, true)).join("");
      bindRowEvents(popularListEl);
    }

    function renderProducts(){
      const kw = (searchInput.value || "").trim().toLowerCase();

      // popularは別枠なので除外
      const list = PRODUCTS.filter(p => !POPULAR_FIXED.some(x=>x.id===p.id))
        .filter(p => !kw || p.name.toLowerCase().includes(kw));

      productListEl.innerHTML = list.map(p => productRowHtml(p, false)).join("");
      bindRowEvents(productListEl);
    }

    searchInput.addEventListener("input", ()=> renderProducts());

    function syncCartFromStorage(){
      cart = loadCart();
    }

    function renderAll(){
      syncCartFromStorage();
      renderHeader();
      renderSettlement();
      renderPopular();
      renderProducts();
    }

    // 初期描画
    renderAll();
  </script>
</body>
</html>
